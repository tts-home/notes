<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-interview docs-version-current docs-doc-page docs-doc-id-database/mysql" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">MySQL  |  🤟 👍 🤘</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://tts-home.github.io/notes/interview/database/mysql"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-interview-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-interview-current"><meta data-rh="true" property="og:title" content="MySQL  |  🤟 👍 🤘"><meta data-rh="true" name="description" content="索引失效"><meta data-rh="true" property="og:description" content="索引失效"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tts-home.github.io/notes/interview/database/mysql"><link data-rh="true" rel="alternate" href="https://tts-home.github.io/notes/interview/database/mysql" hreflang="en"><link data-rh="true" rel="alternate" href="https://tts-home.github.io/notes/interview/database/mysql" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.4ec07408.css">
<script src="/notes/assets/js/runtime~main.dfab72e2.js" defer="defer"></script>
<script src="/notes/assets/js/main.9b0d6f4f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/notes/"><div class="navbar__logo"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">Coding Notes</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_self" href="/notes/interview">Interview</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" target="_self" href="/notes/"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"><b>Coding Notes</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/interview">Interview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/base/collection_map">base</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/cicd/docker">cicd</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/notes/interview/database/elastic_search">database</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/interview/database/elastic_search">Elastic Search</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/interview/database/mysql">MySQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/interview/database/redis">Redis</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/framework/mybatis">framework</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/microservice/dubbo">microservice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/mq/kafka">mq</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/interview/other">Other</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">database</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">MySQL</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>MySQL</h1>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="索引失效">索引失效<a href="#索引失效" class="hash-link" aria-label="Direct link to 索引失效" title="Direct link to 索引失效">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="null"><code>NULL</code><a href="#null" class="hash-link" aria-label="Direct link to null" title="Direct link to null">​</a></h3>
<ul>
<li>索引是有序的，<code>NULL</code> 是不确定值，无法确定其在索引中位置，使用 <code>IS NULL</code> / <code>IS NOT NULL</code> 可能会使索引失效<!-- -->
<ul>
<li>如果字段不允许为空，则 <code>IS NULL</code> / <code>IS NOT NULL</code> 会使索引失效</li>
<li>如果字段允许为空，则 <code>IS NULL</code> 走 <code>ref</code> 类型的索引，而 <code>IS NOT NULL</code> 走 <code>range</code> 类型的索引</li>
</ul>
</li>
<li>如果需要把 <code>NULL</code> 存入索引，方法有二，其一，把 <code>NULL</code> 值转为一个特定的值，在 <code>WHERE</code> 中检索时，用该特定值查找；其二，建立一个复合索引。例如　<code>ALTER TABLE FOO CREATE INDEX IDX_BAR(COL_1, 1)</code>，通过在复合索引中指定一个非空常量值，而使构成索引的列的组合中，不可能出现全空值。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="前导模糊查询">前导模糊查询<a href="#前导模糊查询" class="hash-link" aria-label="Direct link to 前导模糊查询" title="Direct link to 前导模糊查询">​</a></h3>
<ul>
<li><code>LIKE</code> 查询以 <code>%</code> 开头会使索引失效</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="违反最左匹配原则">违反最左匹配原则<a href="#违反最左匹配原则" class="hash-link" aria-label="Direct link to 违反最左匹配原则" title="Direct link to 违反最左匹配原则">​</a></h3>
<ul>
<li>使用联合索引时，缺失左边的索引列会导致索引失效</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="索引列上作操作">索引列上作操作<a href="#索引列上作操作" class="hash-link" aria-label="Direct link to 索引列上作操作" title="Direct link to 索引列上作操作">​</a></h3>
<ul>
<li>在索引列上作任何操作，如计算、函数、类型转换等，会导致索引失效从而全表扫描</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="范围查询">范围查询<a href="#范围查询" class="hash-link" aria-label="Direct link to 范围查询" title="Direct link to 范围查询">​</a></h3>
<ul>
<li>索引中有一个索引列用的是大于、小于等范围值，会导致该列之后的索引列失效</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="or"><code>OR</code><a href="#or" class="hash-link" aria-label="Direct link to or" title="Direct link to or">​</a></h3>
<ul>
<li><code>OR</code> 可能会使索引失效，可在某些场景下使用 <code>UNION</code> 代替</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="not-in"><code>NOT IN</code><a href="#not-in" class="hash-link" aria-label="Direct link to not-in" title="Direct link to not-in">​</a></h3>
<ul>
<li><code>NOT IN</code> 可能会使索引失效，<code>5.7</code> 中是全表扫描，<code>5.8</code> 中使用了 <code>range</code> 类型索引</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="--"><code>!=</code> / <code>&lt;&gt;</code><a href="#--" class="hash-link" aria-label="Direct link to --" title="Direct link to --">​</a></h3>
<ul>
<li><code>!=</code> / <code>&lt;&gt;</code> 可能会使索引失效，<code>5.7</code> 中是全表扫描，<code>5.8</code> 中使用了 <code>range</code> 类型索引</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="类型编码不一致">类型/编码不一致<a href="#类型编码不一致" class="hash-link" aria-label="Direct link to 类型/编码不一致" title="Direct link to 类型/编码不一致">​</a></h3>
<ul>
<li>隐式的类型转换会导致索引失效，进行全表扫描</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="锁">锁<a href="#锁" class="hash-link" aria-label="Direct link to 锁" title="Direct link to 锁">​</a></h2>
<blockquote>
<p><code>MySQL</code> 锁可以按使用方式分为：乐观锁与悲观锁，按粒度分可以分为全局锁、表级锁、行级锁、页级锁。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="全局锁">全局锁<a href="#全局锁" class="hash-link" aria-label="Direct link to 全局锁" title="Direct link to 全局锁">​</a></h3>
<ul>
<li>全局锁就是对整个数据库实例加锁。MySQL提供了一个加全局读锁的方法，命令是 <code>FLUSH TABLES WITH READ LOCK</code>。当需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：数据更新语句（数据的增删改）、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句</li>
<li>全局锁的典型使用场景是做全库逻辑备份，也就是把整库每个表都 <code>SELECT</code> 出来存成文本。但是让整个库都只读，可能出现以下问题：<!-- -->
<ul>
<li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆</li>
<li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的binlog，会导致主从延迟</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="表级锁">表级锁<a href="#表级锁" class="hash-link" aria-label="Direct link to 表级锁" title="Direct link to 表级锁">​</a></h3>
<ul>
<li><code>MySQL</code> 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL）。<!-- -->
<ul>
<li>开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低</li>
</ul>
</li>
<li><code>MySQL</code> 表级锁有两种模式：表共享锁（Table Read Lock）和表独占写锁（Table Write Lock）。<!-- -->
<ul>
<li>对 <code>MyISAM</code> 的读操作，不会阻塞其他用户对同一表请求，但会阻塞对同一表的写请求；</li>
<li>对 <code>MyISAM</code> 的写操作，则会阻塞其他用户对同一表的读和写操作；</li>
<li><code>MyISAM</code> 表的读操作和写操作之间，以及写操作之间是串行的。</li>
</ul>
</li>
<li>当一个线程获得对一个表的写锁后，只有持有锁线程可以对表进行更新操作。其他线程的读、写操作都会等待，直到锁被释放为止。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="行级锁">行级锁<a href="#行级锁" class="hash-link" aria-label="Direct link to 行级锁" title="Direct link to 行级锁">​</a></h3>
<ul>
<li>行级锁是 <code>MySQL</code> 中锁定粒度最细的一种锁，表示只针对当前操作的行进行加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，但加锁的开销也最大。行级锁分为 <code>共享锁</code> 和 <code>排他锁</code>。<!-- -->
<ul>
<li>开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高</li>
<li>基于索引，如果 <code>sql</code> 没有走索引，将会退化为表锁</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="页级锁">页级锁<a href="#页级锁" class="hash-link" aria-label="Direct link to 页级锁" title="Direct link to 页级锁">​</a></h3>
<ul>
<li>页级锁是 <code>MySQL</code> 中锁定粒度介于行级锁和表级锁中间的一种锁。表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。<code>BDB</code> 支持页级锁。<!-- -->
<ul>
<li>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="显式加锁">显式加锁<a href="#显式加锁" class="hash-link" aria-label="Direct link to 显式加锁" title="Direct link to 显式加锁">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">-- 共享锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LOCK</span><span class="token plain"> </span><span class="token operator">IN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHARE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">MODE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 排他锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UPDATE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="悲观锁">悲观锁<a href="#悲观锁" class="hash-link" aria-label="Direct link to 悲观锁" title="Direct link to 悲观锁">​</a></h3>
<ul>
<li>悲观锁（<code>Pessimistic Lock</code>），顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 <code>block</code> 直到它拿到锁。<!-- -->
<ul>
<li>悲观锁：假定会发生并发冲突，  屏蔽一切可能违反数据完整性的操作。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="乐观锁">乐观锁<a href="#乐观锁" class="hash-link" aria-label="Direct link to 乐观锁" title="Direct link to 乐观锁">​</a></h3>
<ul>
<li>乐观锁（<code>Optimistic Lock</code>），顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在提交更新的时候会判断一下在此期间别人有没有去更新这个数据。乐观锁适用于读多写少的应用场景，这样可以提高吞吐量。<!-- -->
<ul>
<li>乐观锁：假设不会发生并发冲突，只在提交操作时检查是否违反数据完整性。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="myisam-vs-innodb"><code>MyISAM</code> vs. <code>InnoDB</code><a href="#myisam-vs-innodb" class="hash-link" aria-label="Direct link to myisam-vs-innodb" title="Direct link to myisam-vs-innodb">​</a></h2>
<ul>
<li>事务：<code>MyISAM</code> 不支持；<code>InnoDB</code> 支持</li>
<li>锁：<code>MyISAM</code> 支持表锁；<code>InnoDB</code> 支持行锁、表锁</li>
<li>主键：<code>MyISAM</code> 可以没有主键；<code>InnoDB</code> 必须有，没有指定会默认生成一个隐藏列作为主键</li>
<li>索引：<code>MyISAM</code> 为非聚集索引，使用 B+ 树作为索引结构，索引和数据文件是分离的，主键索引和辅助索引是独立的；<code>InnoDB</code> 为聚集索引，使用 B+ 树作为索引结构，数据文件和索引绑在一起，必须要有主键，主键索引一次查询，辅助索引两次查询，先查询主键，再查询数据</li>
<li>外键：<code>MyISAM</code> 不支持；<code>InnoDB</code> 支持</li>
<li><code>AUTO_INCREMENT</code>：<code>MyISAM</code> 自增列如果处于组合索引，自增列可以不是第一列，可以根据组合索引左边的列进行排序后递增；<code>InnoDB</code> 必须包含只有自增列的索引，如果自增列处于组合索引，也必须是组合索引的最左列</li>
<li>表的行数：<code>MyISAM</code> 保存了表的行数；<code>InnoDB</code> 没有保存表的行数</li>
<li>全文索引：<code>MyISAM</code> 支持，<code>InnoDB</code> 5.7+(含)支持</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mysql-日志"><code>MySQL</code> 日志<a href="#mysql-日志" class="hash-link" aria-label="Direct link to mysql-日志" title="Direct link to mysql-日志">​</a></h2>
<blockquote>
<p>日志是 <code>MySQL</code> 数据库的重要组成部分。日志文件中记录着 <code>MySQL</code> 数据库运行期间发生的变化，比如客户端连接状况、<code>SQL</code> 语句的执行情况和错误信息等。当数据库遭到意外的损坏时，可以通过日志查看文件出错的原因，并且可以通过日志文件进行数据恢复。<code>MySQL</code> 日志主要包含：错误日志、查询日志、慢查询日志、二进制日志、重做日志、回滚日志等，其中重做日志和回滚日志也称事务日志(<code>InnoDB</code>)。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="错误日志errorlog">错误日志(<code>errorlog</code>)<a href="#错误日志errorlog" class="hash-link" aria-label="Direct link to 错误日志errorlog" title="Direct link to 错误日志errorlog">​</a></h3>
<ul>
<li>错误日志功能是默认开启的，并且错误日志无法被禁止。错误日志记录着 <code>MySQL</code> 启动和停止，以及服务器在运行过程中发生的错误的相关信息。<!-- -->
<ul>
<li>未显式指定开启时，错误日志将被写入标准错误输出 <code>stderr</code>。</li>
<li>通过配置文件中 <code>log-error</code> 选项显式开启，并可通过该选项指定日志存储文件。</li>
<li>如未指定日志存储文件，错误日志将被写入数据目录下 <code>host_name.err</code> 文件中，<code>host_name</code> 为 <code>MySQL</code> 服务器主机名。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="查询日志general-log">查询日志(<code>general log</code>)<a href="#查询日志general-log" class="hash-link" aria-label="Direct link to 查询日志general-log" title="Direct link to 查询日志general-log">​</a></h3>
<ul>
<li>查询日志功能是默认关闭的。查询日志会记录用户的所有操作。<!-- -->
<ul>
<li>查询日志在并发操作大的环境下会产生大量的信息从而导致不必要的<code>磁盘IO</code>，会影响数据库性能的，建议仅在为了调试数据库的目的下开启查询日志。</li>
<li>通过配置文件中 <code>general_log = ON</code> 选项开启，通过配置文件中 <code>log_output = TABLE|FILE</code> 指定日志存储方式。</li>
<li>如果 <code>log_output = TABLE</code>，日志存储在 <code>MySQL.gengera_log</code> 表中。</li>
<li>如果 <code>log_output = FILE</code>，通过配置文件中 <code>general_log_file</code> 指定日志存储文件。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="慢查询日志slow-query-log">慢查询日志(<code>slow query log</code>)<a href="#慢查询日志slow-query-log" class="hash-link" aria-label="Direct link to 慢查询日志slow-query-log" title="Direct link to 慢查询日志slow-query-log">​</a></h3>
<ul>
<li>慢查询日志功能是默认关闭的。慢查询日志用来记录执行时间超过指定时间的查询语句。<!-- -->
<ul>
<li>通过慢查询日志，可以查找出哪些查询语句的执行效率很低，以便进行优化。</li>
<li>一般建议开启，它对服务器性能的影响微乎其微，但是可以记录 <code>MySQL</code> 服务器上执行了很长时间的查询语句，可以帮助定位性能问题。</li>
<li>通过配置文件中 <code>slow_query_log</code> 选项开启慢查询日志。</li>
<li>通过配置文件中 <code>slow-query-log-file</code> 选项指定慢查询日志存储文件。</li>
<li>通过配置文件中 <code>long_query_time</code> 选项指定判定慢查询的时间阈值，时间以秒为单位，可以精确到微秒。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二进制日志">二进制日志<a href="#二进制日志" class="hash-link" aria-label="Direct link to 二进制日志" title="Direct link to 二进制日志">​</a></h3>
<ul>
<li>二进制日志也叫作变更日志，主要用于记录修改数据或有可能引起数据改变的 <code>SQL</code> 语句，并且记录了语句发生时间、执行时长、操作的数据等。<!-- -->
<ul>
<li>通过配置文件中 <code>log_bin = ON|file_name</code> 选项开启或同时指定二进制日志存储目录/文件。</li>
<li>内容是逻辑格式日志，可用于在主从复制中从库利用主库上的 <code>binlog</code> 进行重播实现主从同步，也可用于数据库基于时间点的还原。</li>
<li>事务提交时产生记录，生成时间超过 <code>expire_logs_days</code> 配置的天数之后，会被自动删除。</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="重做日志redo-log">重做日志(<code>redo log</code>)<a href="#重做日志redo-log" class="hash-link" aria-label="Direct link to 重做日志redo-log" title="Direct link to 重做日志redo-log">​</a></h3>
<ul>
<li>确保事务的持久性。<code>redo</code> 日志记录事务执行后的状态，用来恢复未写入 <code>data file</code> 的已成功事务更新的数据。防止在发生故障的时间点，尚有脏页未写入磁盘，在重启 <code>MySQL</code> 服务的时候，根据 <code>redo log</code> 进行重做，从而达到事务的持久性这一特性。<!-- -->
<ul>
<li>内容是物理格式的日志，记录的是物理数据页面的修改的信息，其 <code>redo log</code> 是顺序写入 <code>redo log file</code> 的物理文件中去的。</li>
<li>事务开始后就会产生 <code>redo log</code>，<code>redo log</code> 的落盘并不是随着事务的提交才写入的，而是 在事务的执行过程中，便开始写入 <code>redo log</code> 文件中。</li>
<li>当对应事务的脏页写入到磁盘之后，<code>redo log</code> 的使命也就完成了，重做日志占用的空间就可以重用（被覆盖）。</li>
<li>通过配置文件中 <code>innodb_log_group_home_dir</code> 选项指定日志文件组所在的路径，默认./ ，表示在数据库的数据目录下。</li>
<li>通过配置文件中 <code>innodb_log_files_in_group</code> 选项指定日志文件组中文件的数量，默认 <code>2</code>。</li>
<li>通过配置文件中 <code>innodb_log_file_size</code> 指定日志文件的大小。</li>
<li>通过配置文件中 <code>innodb_mirrored_log_groups</code> 指定日志镜像文件组的数量，默认 <code>1</code>。</li>
<li>重做日志有一个缓存区 <code>innodb_log_buffer</code>，<code>innodb_log_buffer</code> 的默认大小为8M，<code>Innodb</code> 存储引擎先将重做日志写入 <code>innodb_log_buffer</code> 中。<!-- -->
<ul>
<li><code>Master Thread</code> 每秒一次执行刷新 <code>innodb_log_buffer</code> 到日志文件。</li>
<li>每个事务提交时会将重做日志刷新到重做日志文件。</li>
<li>当重做日志缓存可用空间少于一半时，重做日志缓存被刷新到重做日志文件。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="回滚日志undo-log">回滚日志(<code>undo log</code>)<a href="#回滚日志undo-log" class="hash-link" aria-label="Direct link to 回滚日志undo-log" title="Direct link to 回滚日志undo-log">​</a></h3>
<ul>
<li>事务原子性和隔离性实现的基础，保存了事务发生之前的数据的一个版本，可以用于回滚，同时可以提供多版本并发控制下的读（<code>MVCC</code>），也即非锁定读。<!-- -->
<ul>
<li>内容是逻辑格式日志，在执行 <code>undo</code> 时仅将数据从逻辑上恢复至事务之前的状态，而不是从物理页面上操作实现的（不同于 <code>redo log</code>）。</li>
<li>事务开始之前，将当前数据版本生成 <code>undo log</code>，<code>undo</code> 也会产生 <code>redo</code> 来保证 <code>undo log</code> 的可靠性。</li>
<li>当事务提交之后，<code>undo log</code> 并不能立马被删除，而是放入待清理的链表，由 <code>purge</code> 线程判断是否有其他事务在使用 <code>undo</code> 段中表的上一个事务之前的版本信息，决定是否可以清理 <code>undo log</code> 的日志空间。</li>
<li>通过配置文件中 <code>innodb_data_file_path</code> 指定共享表空间路径。（<code>5.6-</code>）</li>
<li>通过配置文件中 <code>innodb_undo_directory</code> 指定独立 <code>undo</code> 表空间存储目录，通过配置文件中 <code>innodb_undo_logs</code> 指定回滚段大小，通过配置文件中 <code>innodb_undo_tablespaces</code> 指定 <code>undo log</code> 文件数量。（<code>5.7+</code>）</li>
</ul>
</li>
<li><code>undo log</code> 主要分为两种<!-- -->
<ul>
<li><code>insert undo log</code>，代表事务在 <code>INSERT</code> 新记录时产生的 <code>undo log</code>，只在事务回滚时需要，并且在事务提交后可以被立即丢弃</li>
<li><code>update undo log</code>（主要），事务在进行 <code>UPDATE</code> 或 <code>DELETE</code> 时产生的 <code>undo log</code>，不仅在事务回滚时需要，在快照读时也需要，所以不能随便删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被 <code>purge</code> 线程统一清除</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redo-log-vs-binlog"><code>redo log</code> vs. <code>binlog</code><a href="#redo-log-vs-binlog" class="hash-link" aria-label="Direct link to redo-log-vs-binlog" title="Direct link to redo-log-vs-binlog">​</a></h3>
<ul>
<li>作用不同：<code>redo log</code> 是用于 <code>crash recovery</code> 的，保证 <code>MySQL</code> 宕机也不会影响持久性；<code>binlog</code> 是用于 <code>point-in-time recovery</code> 的，保证服务器可以基于时间点恢复数据，此外 <code>binlog</code>还用于主从复制。</li>
<li>层次不同：<code>redo log</code> 是 <code>InnoDB</code> 存储引擎实现的，而 <code>binlog</code> 是 <code>MySQL</code> 的服务器层实现的，同时支持 <code>InnoDB</code> 和其他存储引擎。</li>
<li>内容不同：<code>redo log</code> 是物理日志，内容基于磁盘的 <code>Page</code>；<code>binlog</code> 的内容是二进制的，根据 <code>binlog_format</code> 参数的不同，可能基于 <code>SQL</code> 语句、基于数据本身或者二者的混合。</li>
<li>写入时机不同：<code>binlog</code> 在事务提交时写入；<code>redo log</code> 的写入时机相对多元：<!-- -->
<ul>
<li>当事务提交时会调用 <code>fsync</code> 对 <code>redo log</code> 进行刷盘，这是默认情况下的策略，修改 <code>innodb_flush_log_at_trx_COMMIT</code> 参数可以改变该策略，但事务的持久性将无法保证。</li>
<li><code>Master Thread</code> 每秒刷盘一次 <code>redo log</code>，这样的好处是不一定要等到 <code>COMMIT</code> 时刷盘，<code>COMMIT</code> 速度大大加快。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="acid"><code>ACID</code><a href="#acid" class="hash-link" aria-label="Direct link to acid" title="Direct link to acid">​</a></h2>
<blockquote>
<p>事务（<code>Transaction</code>）是访问和更新数据库的程序执行单元，事务中可能包含一个或多个 <code>SQL</code> 语句，这些语句要么都执行，要么都不执行。<code>MySQL</code> 支持事务的存储引擎有 <code>InnoDB</code>、<code>NDB Cluster</code> 等，其中 <code>InnoDB</code> 的使用最为广泛，其他存储引擎不支持事务，如 <code>MyIsam</code>、<code>Memory</code> 等。</p>
</blockquote>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">MySQL 服务器逻辑架构从上往下可以分为三层：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">第一层：处理客户端连接、授权认证等。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">第二层：服务器层，负责查询语句的解析、优化、缓存以及内置函数的实现、存储过程等。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">第三层：存储引擎，负责 MySQL 中数据的存储和提取。MySQL 中服务器层不管理事务，事务是由存储引擎实现的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>按照严格的标准，只有同时满足 <code>ACID</code> 特性才是事务。但是在各大数据库厂商的实现中，真正满足 <code>ACID</code> 的事务少之又少。例如 <code>MySQL</code> 的 <code>NDB Cluster</code> 事务不满足持久性和隔离性，<code>InnoDB</code> 默认事务隔离级别是可重复读，不满足隔离性，<code>Oracle</code> 默认的事务隔离级别为 <code>READ COMMITTED</code>，不满足隔离性。因此与其说 <code>ACID</code> 是事务必须满足的条件，不如说它们是衡量事务的四个维度。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="atomicity"><code>Atomicity</code><a href="#atomicity" class="hash-link" aria-label="Direct link to atomicity" title="Direct link to atomicity">​</a></h3>
<ul>
<li>原子性是指一个事务是一个不可分割的工作单位，其中的操作要么都做，要么都不做；如果事务中一个 <code>sql</code> 语句执行失败，则已执行的语句也必须回滚，数据库退回到事务前的状态。<!-- -->
<ul>
<li>通过 <code>undo log</code> 实现原子性。</li>
<li>对于每个 <code>INSERT</code>，回滚时会执行 <code>DELETE</code></li>
<li>对于每个 <code>DELETE</code>，回滚时会执行 <code>INSERT</code></li>
<li>对于每个 <code>UPDATE</code>，回滚时会执行一个相反的 <code>UPDATE</code>，把数据改回去</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="consistency"><code>Consistency</code><a href="#consistency" class="hash-link" aria-label="Direct link to consistency" title="Direct link to consistency">​</a></h3>
<ul>
<li>一致性是指事务把数据库从一个有效的状态转移成另一个有效状态，事务执行结束后，数据库的完整性没有被破坏，事务执行的前后都是合法的数据状态。一致性是事物追求的最终目标，原子性，隔离性，持久性都是为了保证数据库的一致性。此外，除了数据库底层的保障，一致性的实现也需要应用层的保障。<!-- -->
<ul>
<li>保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证</li>
<li>数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等</li>
<li>应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的 一致</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="isolation"><code>Isolation</code><a href="#isolation" class="hash-link" aria-label="Direct link to isolation" title="Direct link to isolation">​</a></h3>
<ul>
<li>隔离性是指，事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。严格的隔离性，对应了事务隔离级别中的 <code>Serializable</code> （可串行化），但实际应用中出于性能方面的考虑很少会使用可串行化。<!-- -->
<ul>
<li>（一个事务）写操作对（另一个事务）写操作的影响：锁机制保证隔离性</li>
<li>（一个事务）写操作对（另一个事务）读操作的影响：<code>MVCC</code> 保证隔离性</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="durability"><code>Durability</code><a href="#durability" class="hash-link" aria-label="Direct link to durability" title="Direct link to durability">​</a></h3>
<ul>
<li>持久性是指事务一旦提交，它对数据库的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。<!-- -->
<ul>
<li>通过 <code>redo log</code> 实现持久性。</li>
</ul>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    InnoDB 作为 MySQL 的存储引擎，数据是存放在磁盘中的，但如果每次读写数据都需要磁盘 IO，效率会很低。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">为此，InnoDB 提供了缓存(Buffer Pool)，Buffer Pool 中包含了磁盘中部分数据页的映射，作为访问数据库的缓冲。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">当从数据库读取数据时，会首先从 Buffer Pool 中读取，如果 Buffer Pool 中没有，则从磁盘读取后放入 Buffer Pool。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">当向数据库写入数据时，会首先写入 Buffer Pool，Buffer Pool 中修改的数据会定期刷新到磁盘中（这一过程称为刷脏）。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Buffer Pool 的使用大大提高了读写数据的效率，但是也带了新的问题。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">如果 MySQL 宕机，而此时 Buffer Pool 中修改的数据还没有刷新到磁盘，就会导致数据的丢失，事务的持久性无法保证。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    于是，redo log 被引入来解决这个问题。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">当数据修改时，除了修改 Buffer Pool 中的数据，还会在 redo log 记录这次操作。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">当事务提交时，会调用 fsync 接口对 redo log 进行刷盘。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">如果 MySQL 宕机，重启时可以读取 redo log 中的数据，对数据库进行恢复。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">redo log 采用的是 WAL（Write-ahead logging，预写式日志），所有修改先写入日志，再更新到 Buffer Pool，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">保证了数据不会因 MySQL 宕机而丢失，从而满足了持久性要求。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    既然 redo log 也需要在事务提交时将日志写入磁盘，为什么它比直接将 Buffer Pool 中修改的数据写入磁盘(即刷脏)要快呢？</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    主要有以下两方面的原因：</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    （1）刷脏是随机 IO，因为每次修改的数据位置随机，但写 redo log 是追加操作，属于顺序 IO。</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    （2）刷脏是以数据页（Page）为单位的，MySQL 默认页大小是 16KB，一个 Page 上一个小修改都要整页写入；</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">而 redo log 中只包含真正需要写入的部分，无效 IO 大大减少。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mvcc"><code>MVCC</code><a href="#mvcc" class="hash-link" aria-label="Direct link to mvcc" title="Direct link to mvcc">​</a></h2>
<blockquote>
<p>全称 <code>Multi-Version Concurrency Control</code>，即多版本并发控制，主要是为了提高数据库的并发性能。<code>MVCC</code> 为事务分配单向增长的时间戳，维持一个数据的多个版本，使读写操作没有冲突的一个抽象概念  。可解决脏读、幻读、不可重复读等事务隔离问题。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="当前读">当前读<a href="#当前读" class="hash-link" aria-label="Direct link to 当前读" title="Direct link to 当前读">​</a></h3>
<ul>
<li>读取的数据库记录都是当前最新的版本，会对当前读取的数据进行加锁，防止其他事务修改数据，是悲观锁的一种操作。<!-- -->
<ul>
<li><code>SELECT LOCK IN SHARE MODE</code> (共享锁)</li>
<li><code>SELECT FOR UPDATE</code> (排他锁)</li>
<li><code>INSERT / UPDATE / DELETE</code> (排他锁)</li>
<li>串行化事务隔离级别</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="快照读">快照读<a href="#快照读" class="hash-link" aria-label="Direct link to 快照读" title="Direct link to 快照读">​</a></h3>
<ul>
<li>基于多版本并发控制（<code>MVCC</code>），读到的数据不一定是当前最新的数据，有可能是之前历史版本的数据。<!-- -->
<ul>
<li>不加锁的 <code>SELECT</code> 操作（注：事务级别不是串行化）</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="实现原理">实现原理<a href="#实现原理" class="hash-link" aria-label="Direct link to 实现原理" title="Direct link to 实现原理">​</a></h3>
<ul>
<li>主要通过<code>版本链</code>，<code>undo log</code> ，<code>Read Viev</code> 来实现</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="版本链">版本链<a href="#版本链" class="hash-link" aria-label="Direct link to 版本链" title="Direct link to 版本链">​</a></h4>
<ul>
<li><code>InnoDB</code> 的每行数据有一个隐藏的 <code>db_roll_pointer</code> 字段，是一个回滚指针，用于配合 <code>undo log</code>，指向上一个旧版本。每次对数据库记录进行改动，都会记录一条 <code>undo log</code>，每条 <code>undo log</code> 也都有一个 <code>roll_pointer</code> 属  性（<code>INSERT</code> 操作对应的 <code>undo log</code> 没有该属性，因为该记录并没有更早的版本），可以将这些 <code>undo log</code> 都连起来，串成一个链表，称之为版本链。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="read-viev读视图"><code>Read Viev</code>（读视图）<a href="#read-viev读视图" class="hash-link" aria-label="Direct link to read-viev读视图" title="Direct link to read-viev读视图">​</a></h4>
<ul>
<li>主要是用来做可见性判断的, 即当某个事务执行快照读的时候，对该记录创建一个 <code>Read Viev</code> 读视图，用来判断当前事务能够看到哪个版本的数据，既可能是当前最新的数据，也有可能是该行记录的 <code>undo log</code> 里面的某个版本的数据。</li>
<li><code>Read Viev</code> 属性<!-- -->
<ul>
<li><code>trx_ids</code>: 当前系统活跃（未提交）事务版本号集合</li>
<li><code>low_limit_id</code>: 创建当前 <code>Read Viev</code> 时当前系统最大事务版本号 + 1</li>
<li><code>up_limit_id</code>: 创建当前 <code>Read Viev</code> 时系统正处于活跃事务最小版本号</li>
<li><code>creator_trx_id</code>: 创建当前 <code>Read Viev</code> 的事务版本号</li>
</ul>
</li>
<li><code>Read Viev</code> 可见性判断条件<!-- -->
<ul>
<li><code>db_trx_id &lt; up_limit_id || db_trx_id == creator_trx_id</code>（显示）<!-- -->
<ul>
<li>如果事务 <code>ID</code> 小于 <code>Read Viev</code> 中的最小活跃事务 <code>ID</code>，则可以肯定该数据是在当前事务启之前就已经存在了的，可以显示</li>
<li>如果事务 <code>ID</code> 等于 <code>creator_trx_id</code>，那么说明数据就是当前事务生成的，可以显示</li>
</ul>
</li>
<li><code>db_trx_id &gt;= low_limit_id</code>（不显示）<!-- -->
<ul>
<li>如果事务 <code>ID</code> 大于 <code>Read Viev</code> 中的当前系统的最大事务 <code>ID</code>，则数据是在当前 <code>Read Viev</code> 创建之后产生的，不显示</li>
<li>如果小于则进入下一个判断</li>
</ul>
</li>
<li><code>db_trx_id</code> 是否在活跃事务 <code>trx_ids</code> 中<!-- -->
<ul>
<li>不存在，则说明 <code>Read Viev</code> 产生的时候事务已经 <code>COMMIT</code> 了，可以显示</li>
<li>已存在，则代表 <code>Read Viev</code> 产生的时候事务还在活跃（没有 <code>COMMIT</code>），不显示</li>
</ul>
</li>
</ul>
</li>
<li><code>Read View</code> 用于支持 <code>RC</code>（<code>Read Committed</code>，读提交）和 <code>RR</code>（<code>Repeatable Read</code>，可重复读）隔离级别的实现</li>
<li><code>RR</code>、<code>RC</code> 隔离级别下 <code>Read View</code> 生成时机<!-- -->
<ul>
<li><code>RC</code> 隔离级别下，每个快照读都会生成并获取最新的 <code>Read View</code></li>
<li><code>RR</code> 隔离级别下，同一个事务中的第一个快照读会创建 <code>Read View</code>, 之后的快照读获取的都是同一个 <code>Read View</code></li>
</ul>
</li>
<li><code>RC</code>、<code>RR</code> 隔离级别下快照读区别<!-- -->
<ul>
<li><code>RR</code> 级别下事务对某条记录的第一次快照读会创建一个快照及 <code>Read View</code>， 将当前系统活跃的其他事务记录起来，此后在调用快照读的时候，使用的是同一个 <code>Read View</code>，所以只要当前事务在其他事务提交更新之前使用过快照读，那么之后的快照读使用的都是同一个 <code>Read View</code>，所以对之后的修改不可见，即 <code>RR</code> 级别下，快照读生成 <code>Read View</code> 时，<code>Read View</code> 会记录此时所有其他活动事务的快照，这些事务的修改对于当前事务都是不可见的，而早于 <code>Read View</code> 创建的事务所做的修改均是可见</li>
<li><code>RC</code> 级别下事务每次快照读都会新生成一个快照和 <code>Read View</code>, 所以 <code>RC</code> 级别事务中可以看到其他事务提交的更新</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mysql-对幻读的处理"><code>MySQL</code> 对幻读的处理<a href="#mysql-对幻读的处理" class="hash-link" aria-label="Direct link to mysql-对幻读的处理" title="Direct link to mysql-对幻读的处理">​</a></h2>
<ul>
<li>快照读：通过 <code>MVCC</code> 来进行控制的，不用加锁</li>
<li>当前读：通过 <code>next-key</code> 锁（行锁 + <code>gap</code> 锁）来解决</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="聚集索引-vs-非聚集索引">聚集索引 vs. 非聚集索引<a href="#聚集索引-vs-非聚集索引" class="hash-link" aria-label="Direct link to 聚集索引 vs. 非聚集索引" title="Direct link to 聚集索引 vs. 非聚集索引">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="聚集索引">聚集索引<a href="#聚集索引" class="hash-link" aria-label="Direct link to 聚集索引" title="Direct link to 聚集索引">​</a></h3>
<ul>
<li>索引中键值的逻辑顺序决定了表中相应行的物理顺序，只要是索引是连续的，那么数据在存储介质上的存储位置也是连续的</li>
<li>查询效率快，只要找到第一个索引值记录，其余连续性的记录在物理也一样连续存放</li>
<li>修改慢，因为为了保证表中记录的物理和索引顺序一致，在记录插入的时候，会对数据页重新排序</li>
<li>因为在物理内存中的顺序只能有一种，所以聚集索引在一个表中只能有一个</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="非聚集索引">非聚集索引<a href="#非聚集索引" class="hash-link" aria-label="Direct link to 非聚集索引" title="Direct link to 非聚集索引">​</a></h3>
<ul>
<li>索引的逻辑顺序与磁盘上的物理存储顺序不同，非聚集索引的键值在逻辑上也是连续的，但是表中的数据在存储介质上的物理顺序是不一致的，即记录的逻辑顺序和实际存储的物理顺序没有任何联系</li>
<li>叶子层并不和实际数据页相重叠，叶子层包含一个指向表中的记录在数据页中的指针</li>
<li>层次多，不会造成数据重排</li>
<li>非聚集索引一个表可以存在多个</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="btree"><code>B+Tree</code><a href="#btree" class="hash-link" aria-label="Direct link to btree" title="Direct link to btree">​</a></h2>
<p><a href="https://www.cnblogs.com/cangqinglang/p/15042752.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/cangqinglang/p/15042752.html</a></p>
<ul>
<li>与 <code>B-Tree</code> 相比，<code>B+Tree</code> 有以下不同点：<!-- -->
<ul>
<li>每个节点的指针上限为 <code>2d</code> 而不是 <code>2d + 1</code></li>
<li>内节点不存储 <code>data</code>，只存储 <code>key</code>，叶子节点不存储指针</li>
<li>每个叶子节点增加一个指向相邻叶子节点的指针，就形成了带有顺序访问指针的 <code>B+Tree</code>，做这个优化的目的是为了提高区间访问的性能</li>
</ul>
</li>
<li>平衡二叉树每个节点只存储一个键值和数据的，如果要存储海量的数据，那么二叉树的节点将会非常多，高度也会极其高，查找数据时会进行很多次磁盘 <code>IO</code>，查找数据的效率将会极低</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mysql-主从同步"><code>MySQL</code> 主从同步<a href="#mysql-主从同步" class="hash-link" aria-label="Direct link to mysql-主从同步" title="Direct link to mysql-主从同步">​</a></h2>
<blockquote>
<p>主从同步使得数据可以从一个数据库服务器复制到其他服务器上，在复制数据时，一个服务器充当主服务器（<code>master</code>），其余的服务器充当从服务器（<code>slave</code>）。因为复制是异步进行的，所以从服务器不需要一直连接着主服务器，从服务器甚至可以通过拨号断 断续续地连接主服务器。通过配置文件，可以指定复制所有的数据库，某个数据库，甚至是某个数据库上的某个表。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主从同步的好处">主从同步的好处<a href="#主从同步的好处" class="hash-link" aria-label="Direct link to 主从同步的好处" title="Direct link to 主从同步的好处">​</a></h3>
<ul>
<li>读写分离，让主库负责写，从库负责读，即使主库出现了锁表的情景，通过读从库也可以保证业务的正常运行</li>
<li>高可用，数据实时备份（热备），主库宕机后能够及时替换主库，保证业务可用性</li>
<li>架构的扩展，增加多个数据存储节点，将负载分布在多个从节点上，可降低磁盘 <code>I/O</code> 访问的频率，提高单个机器的 <code>I/O</code> 性能</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主从形式">主从形式<a href="#主从形式" class="hash-link" aria-label="Direct link to 主从形式" title="Direct link to 主从形式">​</a></h3>
<ul>
<li>一主一从</li>
<li>一主多从</li>
<li>多主一从 （<code>5.7+</code>）<!-- -->
<ul>
<li>可将多个主节点数据备份到一台存储性能比较好的从节点上</li>
</ul>
</li>
<li>双主复制<!-- -->
<ul>
<li>互做主从复制，两个节点互为 <code>master/slave</code>，任一节点所做的变更都会复制应用到另外一个节点</li>
</ul>
</li>
<li>级联复制<!-- -->
<ul>
<li>部分从节点不直接从主节点同步数据，而是从与主节点直连的从节点同步数据（主节点有太多的从节点，会损耗一部分性能用于 <code>replication</code>，可以让 <code>3 ~ 5</code>个从节点连接主节点，其它从节点作为二级或者三级与从节点连接，这样不仅可以缓解主节点的压力，并且对数据一致性没有负面影响）</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主从同步  方法">主从同步方法<a href="#主从同步方法" class="hash-link" aria-label="Direct link to 主从同步方法" title="Direct link to 主从同步方法">​</a></h3>
<ul>
<li>有多种主从同步的方法<!-- -->
<ul>
<li><code>Statement Based Replication</code>（<code>SBR</code>）基于 <code>SQL</code> 语句的复制 （<code>mysql5.6</code> 默认使用）<!-- -->
<ul>
<li>日志文件更小</li>
<li>记录了所有的语句，可以用来日后审计</li>
<li>部分函数语句不能被正确地复制</li>
<li><code>INSERT ... SELECT</code> 语句会执行大量的行级锁表</li>
<li><code>UPDATE</code> 语句会执行大量的行级锁表来扫描整个表</li>
</ul>
</li>
<li><code>Row Based Replication</code>（<code>RBR</code>）基于行的复制<!-- -->
<ul>
<li>所有的数据变化都是被复制，这是最安全的复制方式</li>
<li>更少的行级锁表</li>
<li>日志会很大</li>
<li>不能通过查看日志来审计执行过的 <code>sql</code> 语句（可通过 <code>mysqlbinlog --base64-output=decode-rows --verbose</code> 查看数据变动）</li>
</ul>
</li>
<li><code>Mixed Based Replication</code>（<code>MBR</code>） - <code>SQL</code> + 行混合复制（既使用 <code>SBR</code> 也使用 <code>RBR</code>，默认使用 <code>SBR</code>）</li>
<li><code>global transaction identifiers</code>（<code>GTIDs</code>）基于事务的复制(<code>GTIDs</code> 完全基于事务，可大大简化复制过程，只要在主节点上提交了事务，从节点就一定会执行该事务）</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="配置主从同步">配置主从同步<a href="#配置主从同步" class="hash-link" aria-label="Direct link to 配置主从同步" title="Direct link to 配置主从同步">​</a></h3>
<ul>
<li>主节点操作<!-- -->
<ol>
<li>开启二进制日志，并配置一个独立的 <code>ID</code>（<code>server-id</code>）</li>
</ol>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server-id = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log-bin = mysql-bin                                                # 日志文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog_format = MIXED                                              # 日志记录的格式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">max_binlog_size = 512M  　　　                                      # 单个日志文件最大</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">expire_logs_day = 3                                                # 日志有效期（天）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog_do_db = db1,db2                                             # 日志记录的数据库</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog_ignore_db = mysql,performance_schema,information_schema     # 日志记录忽略的数据库</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>创建一个用来专门同步数据的账号</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GRANT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">REPLICATION</span><span class="token plain"> SLAVE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ON</span><span class="token plain"> </span><span class="token operator">*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">to</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;slave&#x27;</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">@&#x27;192.168.1.253&#x27;</span><span class="token plain"> IDENTIFIED </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> caching_sha2_password </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">BY</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;123456&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>刷新并锁表（只允许查数据不允许写数据）</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">FLUSH </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLES</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">READ</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">LOCK</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>备份要同步的数据库的数据，拷贝到从节点（仅在主节点已有数据时需要）</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">-- 主节点导出数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldump </span><span class="token operator">-</span><span class="token plain">uroot </span><span class="token operator">-</span><span class="token plain">p db1 </span><span class="token operator">&gt;</span><span class="token plain"> db1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysqldump </span><span class="token operator">-</span><span class="token plain">uroot </span><span class="token operator">-</span><span class="token plain">p db2 </span><span class="token operator">&gt;</span><span class="token plain"> db2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">-- 从节点导入数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql </span><span class="token operator">-</span><span class="token plain">uroot </span><span class="token operator">-</span><span class="token plain">p db1 </span><span class="token operator">&lt;</span><span class="token plain"> db1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql </span><span class="token operator">-</span><span class="token plain">uroot </span><span class="token operator">-</span><span class="token plain">p db2 </span><span class="token operator">&lt;</span><span class="token plain"> db2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">sql</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="5">
<li>查询并记录 <code>Position</code> 和 <code>File</code> 的值（从节点配置同步用）</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHOW</span><span class="token plain"> MASTER </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">STATUS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>在完成从节点操作后（从节点同步状态正常），解锁表</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">UNLOCK</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TABLES</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>从节点操作<!-- -->
<ol>
<li>开启二进制日志，并配置一个独立的 <code>ID</code>（<code>server-id</code>）</li>
</ol>
<div class="language-conf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-conf codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server-id = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log-bin = mysql-bin                                                # 日志文件，建议开启，可能变主节点</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog_format = MIXED                                              # 日志记录的格式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">max_binlog_size = 512M  　　　                                      # 单个日志文件最大</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">expire_logs_day = 3                                                # 日志有效期（天）</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replicate_do_db = db1,db2                                          # 复制的数据库</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">replicate-ignore-db = mysql,performance_schema,information_schema  # 忽略的数据库</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">relay_log_recovery = 1                                             # 建议开启，有利于数据一致性</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log_slave_updates = 1                                              # 建议开启，可能变主节点</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>重启从节点，执行如下命令(先停止同步，然后设置同步信息，<code>master_log_file</code> 和 <code>master_log_pos</code> 从主节点查询)</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">STOP SLAVE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CHANGE MASTER </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_host </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;192.168.1.252&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_user </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;slave&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_password </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;123456&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_port </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3306</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_file </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mysql-bin.000023&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_pos </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2720</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">-- 定义通道名称，可用于多主同步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> CHANNEL </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;channel_name&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                        </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SLAVE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">START</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>检查从节点同步状态</li>
</ol>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SHOW</span><span class="token plain"> SLAVE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">STATUS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<!-- -->主要看这几项<!-- -->
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">lave_IO_Running: Yes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Slave_SQL_Running: Yes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Master_Log_File: mysql-bin.000023</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Relay_Master_Log_File: mysql-bin.000023</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Read_Master_Log_Pos: 2720</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Exec_master_log_pos: 2720</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主从复制的流程">主从复制的流程<a href="#主从复制的流程" class="hash-link" aria-label="Direct link to 主从复制的流程" title="Direct link to 主从复制的流程">​</a></h3>
<ol>
<li>主节点的更新事件（<code>UPDATE</code>、<code>INSERT</code>、<code>DELETE</code>）被写到 <code>binlog</code></li>
<li>从节点通过 <code>I/O 线程</code> 创建到主节点的连接，连接后向主节点发送身份信息、所需的 <code>binlog</code> 文件名及偏移量</li>
<li>主节点开启 <code>dump 线程</code>（有多个从节点时会分别开启 <code>dump</code> 线程）与从库建立连接，连接后校验从库的身份信息，然后根据从节点发来的 <code>binlog</code> 文件名及偏移量，从本地读取指定 <code>binlog</code> 文件，发送给从库</li>
<li>从节点拿到 <code>binlog</code> 数据后，将其写入本地的中继日志（<code>relay log</code>）</li>
<li>从库的 <code>SQL 线程</code> 读取中继日志，逐个解析出日志里的命令，然后执行这些命令</li>
</ol>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="多主一从同步">多主一从同步<a href="#多主一从同步" class="hash-link" aria-label="Direct link to 多主一从同步" title="Direct link to 多主一从同步">​</a></h3>
<ul>
<li>基本操作与一主一从同步一致，从节点配置同步略有不同。</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">STOP SLAVE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CHANGE MASTER </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_host </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;192.168.1.252&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_user </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;slave&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_password </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;123456&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_port </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3306</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_file </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mysql-bin.000023&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_pos </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2720</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">-- 定义通道名称，可用于多主同步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> CHANNEL </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;channel_1&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CHANGE MASTER </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">TO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_host </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;192.168.1.253&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_user </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;slave&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_password </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;123456&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_port </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3306</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_file </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mysql-bin.000023&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    master_log_pos </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2720</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">-- 定义通道名称，可用于多主同步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FOR</span><span class="token plain"> CHANNEL </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;channel_2&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">                                         </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SLAVE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">START</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双主同步">双主同步<a href="#双主同步" class="hash-link" aria-label="Direct link to 双主同步" title="Direct link to 双主同步">​</a></h2>
<ul>
<li>基本操作与一主一从同步一致，只不过转换角色再操作一遍。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="索引下推">索引下推<a href="#索引下推" class="hash-link" aria-label="Direct link to 索引下推" title="Direct link to 索引下推">​</a></h2></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/interview/database/elastic_search"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Elastic Search</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/interview/database/redis"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Redis</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#索引失效" class="table-of-contents__link toc-highlight">索引失效</a><ul><li><a href="#null" class="table-of-contents__link toc-highlight"><code>NULL</code></a></li><li><a href="#前导模糊查询" class="table-of-contents__link toc-highlight">前导模糊查询</a></li><li><a href="#违反最左匹配原则" class="table-of-contents__link toc-highlight">违反最左匹配原则</a></li><li><a href="#索引列上作操作" class="table-of-contents__link toc-highlight">索引列上作操作</a></li><li><a href="#范围查询" class="table-of-contents__link toc-highlight">范围查询</a></li><li><a href="#or" class="table-of-contents__link toc-highlight"><code>OR</code></a></li><li><a href="#not-in" class="table-of-contents__link toc-highlight"><code>NOT IN</code></a></li><li><a href="#--" class="table-of-contents__link toc-highlight"><code>!=</code> / <code>&lt;&gt;</code></a></li><li><a href="#类型编码不一致" class="table-of-contents__link toc-highlight">类型/编码不一致</a></li></ul></li><li><a href="#锁" class="table-of-contents__link toc-highlight">锁</a><ul><li><a href="#全局锁" class="table-of-contents__link toc-highlight">全局锁</a></li><li><a href="#表级锁" class="table-of-contents__link toc-highlight">表级锁</a></li><li><a href="#行级锁" class="table-of-contents__link toc-highlight">行级锁</a></li><li><a href="#页级锁" class="table-of-contents__link toc-highlight">页级锁</a></li><li><a href="#显式加锁" class="table-of-contents__link toc-highlight">显式加锁</a></li><li><a href="#悲观锁" class="table-of-contents__link toc-highlight">悲观锁</a></li><li><a href="#乐观锁" class="table-of-contents__link toc-highlight">乐观锁</a></li></ul></li><li><a href="#myisam-vs-innodb" class="table-of-contents__link toc-highlight"><code>MyISAM</code> vs. <code>InnoDB</code></a></li><li><a href="#mysql-日志" class="table-of-contents__link toc-highlight"><code>MySQL</code> 日志</a><ul><li><a href="#错误日志errorlog" class="table-of-contents__link toc-highlight">错误日志(<code>errorlog</code>)</a></li><li><a href="#查询日志general-log" class="table-of-contents__link toc-highlight">查询日志(<code>general log</code>)</a></li><li><a href="#慢查询日志slow-query-log" class="table-of-contents__link toc-highlight">慢查询日志(<code>slow query log</code>)</a></li><li><a href="#二进制日志" class="table-of-contents__link toc-highlight">二进制日志</a></li><li><a href="#重做日志redo-log" class="table-of-contents__link toc-highlight">重做日志(<code>redo log</code>)</a></li><li><a href="#回滚日志undo-log" class="table-of-contents__link toc-highlight">回滚日志(<code>undo log</code>)</a></li><li><a href="#redo-log-vs-binlog" class="table-of-contents__link toc-highlight"><code>redo log</code> vs. <code>binlog</code></a></li></ul></li><li><a href="#acid" class="table-of-contents__link toc-highlight"><code>ACID</code></a><ul><li><a href="#atomicity" class="table-of-contents__link toc-highlight"><code>Atomicity</code></a></li><li><a href="#consistency" class="table-of-contents__link toc-highlight"><code>Consistency</code></a></li><li><a href="#isolation" class="table-of-contents__link toc-highlight"><code>Isolation</code></a></li><li><a href="#durability" class="table-of-contents__link toc-highlight"><code>Durability</code></a></li></ul></li><li><a href="#mvcc" class="table-of-contents__link toc-highlight"><code>MVCC</code></a><ul><li><a href="#当前读" class="table-of-contents__link toc-highlight">当前读</a></li><li><a href="#快照读" class="table-of-contents__link toc-highlight">快照读</a></li><li><a href="#实现原理" class="table-of-contents__link toc-highlight">实现原理</a></li></ul></li><li><a href="#mysql-对幻读的处理" class="table-of-contents__link toc-highlight"><code>MySQL</code> 对幻读的处理</a></li><li><a href="#聚集索引-vs-非聚集索引" class="table-of-contents__link toc-highlight">聚集索引 vs. 非聚集索引</a><ul><li><a href="#聚集索引" class="table-of-contents__link toc-highlight">聚集索引</a></li><li><a href="#非聚集索引" class="table-of-contents__link toc-highlight">非聚集索引</a></li></ul></li><li><a href="#btree" class="table-of-contents__link toc-highlight"><code>B+Tree</code></a></li><li><a href="#mysql-主从同步" class="table-of-contents__link toc-highlight"><code>MySQL</code> 主从同步</a><ul><li><a href="#主从同步的好处" class="table-of-contents__link toc-highlight">主从同步的好处</a></li><li><a href="#主从形式" class="table-of-contents__link toc-highlight">主从形式</a></li><li><a href="#主从同步方法" class="table-of-contents__link toc-highlight">主从同步方法</a></li><li><a href="#配置主从同步" class="table-of-contents__link toc-highlight">配置主从同步</a></li><li><a href="#主从复制的流程" class="table-of-contents__link toc-highlight">主从复制的流程</a></li><li><a href="#多主一从同步" class="table-of-contents__link toc-highlight">多主一从同步</a></li></ul></li><li><a href="#双主同步" class="table-of-contents__link toc-highlight">双主同步</a></li><li><a href="#索引下推" class="table-of-contents__link toc-highlight">索引下推</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 TTS, Inc. Built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
</body>
</html>