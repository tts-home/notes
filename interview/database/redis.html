<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-interview docs-version-current docs-doc-page docs-doc-id-database/redis" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Redis  |  🤟 👍 🤘</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://tts-home.github.io/notes/interview/database/redis"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-interview-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-interview-current"><meta data-rh="true" property="og:title" content="Redis  |  🤟 👍 🤘"><meta data-rh="true" name="description" content="分布式锁"><meta data-rh="true" property="og:description" content="分布式锁"><link data-rh="true" rel="icon" href="/notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://tts-home.github.io/notes/interview/database/redis"><link data-rh="true" rel="alternate" href="https://tts-home.github.io/notes/interview/database/redis" hreflang="en"><link data-rh="true" rel="alternate" href="https://tts-home.github.io/notes/interview/database/redis" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.09f60acf.css">
<script src="/notes/assets/js/runtime~main.3226e656.js" defer="defer"></script>
<script src="/notes/assets/js/main.3c48c977.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"dark")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/notes/"><div class="navbar__logo"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"></div><b class="navbar__title text--truncate">Coding Notes</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" target="_self" href="/notes/interview">Interview</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" target="_self" href="/notes/"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--light_NVdE" height="32" width="32"><img src="/notes/img/tts.png" alt="TTS" class="themedComponent_mlkZ themedComponent--dark_xIcU" height="32" width="32"><b>Coding Notes</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/interview">Interview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/base/collection_map">base</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/cicd/docker">cicd</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/notes/interview/database/elastic_search">database</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/interview/database/elastic_search">Elastic Search</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/interview/database/mysql">MySQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/interview/database/redis">Redis</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/framework/mybatis">framework</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/microservice/dubbo">microservice</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes/interview/mq/kafka">mq</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/interview/other">Other</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">database</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Redis</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Redis</h1></header>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式锁">分布式锁<a href="#分布式锁" class="hash-link" aria-label="Direct link to 分布式锁" title="Direct link to 分布式锁">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="保证加锁时设置过期时间的原子性">保证加锁时设置过期时间的原子性<a href="#保证加锁时设置过期时间的原子性" class="hash-link" aria-label="Direct link to 保证加锁时设置过期时间的原子性" title="Direct link to 保证加锁时设置过期时间的原子性">​</a></h3>
<ul>
<li><code>redis.setnx(key, value)</code> 无法设置过期时间</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">setnx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">expire</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述操作无法保证原子性，可用下面的方案代替</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">25</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;NX&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="防止超时后释放锁时误删其他线程的锁">防止超时后释放锁时误删其他线程的锁<a href="#防止超时后释放锁时误删其他线程的锁" class="hash-link" aria-label="Direct link to 防止超时后释放锁时误删其他线程的锁" title="Direct link to 防止超时后释放锁时误删其他线程的锁">​</a></h3>
<ul>
<li>假如线程 <code>A</code> 成功得到了锁，并且设置的超时时间是 <code>25</code> 秒。由于某些原因导致线程 <code>A</code> 执行的很慢很慢，过了 <code>25</code> 秒都没执行完，这时候锁过期自动释放，线程 <code>B</code> 得到了锁。随后，线程 <code>A</code> 执行完了任务，执行 <code>del</code>  指令来释放锁。但这时候线程 <code>B</code> 还没执行完，线程 <code>A</code> 实际上删除的是线程 <code>B</code> 加的锁。</li>
<li>可以在加锁的时候把当前的线程 <code>id</code> 当做 <code>value</code> ，并在删除之前验证 <code>key</code> 对应的 <code>value</code> 是不是自己线程的 <code>id</code>。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="保证删除锁时的原子性">保证删除锁时的原子性<a href="#保证删除锁时的原子性" class="hash-link" aria-label="Direct link to 保证删除锁时的原子性" title="Direct link to 保证删除锁时的原子性">​</a></h3>
<ul>
<li>防止超时后释放锁时误删其他线程的锁时，加入了判断逻辑，使得删除锁的操作变成了非原子操作。</li>
<li>使用 <code>Lua</code> 脚本来保证删除锁操作的原子性</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token class-name">String</span><span class="token plain"> luaScript </span><span class="token operator">=</span><span class="token plain"> &#x27;</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;get&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">KEYS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">ARGV</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> then </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token char" style="color:rgb(255, 121, 198)">&#x27;del&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">KEYS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> end&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">redis</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">eval</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">luaScript </span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">singletonList</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token function" style="color:rgb(80, 250, 123)">singletonList</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">threadId</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="跳表">跳表<a href="#跳表" class="hash-link" aria-label="Direct link to 跳表" title="Direct link to 跳表">​</a></h2>
<ul>
<li>链表加多级索引的结构，就是跳表，是为了解决平衡二叉树复杂的问题，是平衡树的一种替代品，以一种较为简单的方式实现了平衡二叉树的功能。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="skiplist-与平衡树哈希表的比较"><code>skiplist</code> 与平衡树、哈希表的比较<a href="#skiplist-与平衡树哈希表的比较" class="hash-link" aria-label="Direct link to skiplist-与平衡树哈希表的比较" title="Direct link to skiplist-与平衡树哈希表的比较">​</a></h3>
<ul>
<li><code>skiplist</code> 和各种平衡树（如 <code>AVL</code>、红黑树等）的元素是有序排列的，而哈希表不是有序的，在哈希表上只能做单个 <code>key</code> 的查找，不适宜做范围查找。</li>
<li>在做范围查找的时候，平衡树比 <code>skiplist</code> 操作要复杂。在平衡树上，找到指定范围的小值之后，还需要以中序遍历的顺序继续寻找其它不超过大值的节点。而在 <code>skiplist</code> 上进行范围查找就非常简单，只需要在找到小值之后，对第一层链表进行若干步的遍历就可以实现。</li>
<li>平衡树的插入和删除操作可能引发子树的调整，逻辑复杂，而 <code>skiplist</code> 的插入和删除只需要修改相邻节点的指针，操作简单又快速。</li>
<li>从内存占用上来说，<code>skiplist</code> 比平衡树更灵活一些。一般来说，平衡树每个节点包含 <code>2</code> 个指针（分别指向左右子树），而 <code>skiplist</code> 每个节点包含的指针数目平均为 <code>1/(1-p)</code>，具体取决于参数 <code>p</code> 的大小。如果像 <code>Redis</code> 里的实现一样，取 <code>p = 1/4</code>，那么平均每个节点包含 <code>1.33</code> 个指针 ，比平衡树更有优势。</li>
<li>查找单个 <code>key</code>，<code>skiplist</code> 和平衡树的时间复杂度都为 <code>O(logn)</code>，大体相当，而哈希表在保持较低的哈希值冲突概率的前提下，查找时间复杂度接近 <code>O(1)</code>，性能更高一些。</li>
<li>从算法实现难度上来比较，<code>skiplist</code> 比平衡树要简单得多。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="bigkey"><code>BigKey</code><a href="#bigkey" class="hash-link" aria-label="Direct link to bigkey" title="Direct link to bigkey">​</a></h2>
<ul>
<li>通常将含有较大数据或含有大量成员、列表数的 <code>Key</code> 称之为大 <code>Key</code></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="常见衡量指标">常见衡量指标<a href="#常见衡量指标" class="hash-link" aria-label="Direct link to 常见衡量指标" title="Direct link to 常见衡量指标">​</a></h3>
<ul>
<li>一个 <code>STRING</code> 类型的 <code>Key</code>，它的值为 <code>5MB</code>（数据过大）</li>
<li>一个 <code>LIST</code> 类型的 <code>Key</code>，它的列表数量为 <code>20000</code> 个（列表数量过多）</li>
<li>一个 <code>ZSET</code> 类型的 <code>Key</code>，它的成员数量为 <code>10000</code> 个（成员数量过多）</li>
<li>一个 <code>HASH</code> 格式的 <code>Key</code>，它的成员数量虽然只有 <code>1000</code> 个但这些成员的 <code>value</code> 总大小为 <code>100MB</code>（成员体积过大）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="带来的问题">带来的问题<a href="#带来的问题" class="hash-link" aria-label="Direct link to 带来的问题" title="Direct link to 带来的问题">​</a></h3>
<ul>
<li><code>Redis</code> 实例变慢</li>
<li><code>Redis</code> 实例内存不断变大引发 <code>OOM</code>，或达到 <code>maxmemory</code> 设置值引发写阻塞或重要 <code>Key</code> 被逐出</li>
<li><code>Redis Cluster</code> 中的某个 <code>node</code> 内存远超其余 <code>node</code>，但因 <code>Redis Cluster</code> 的数据迁移最小粒度为 <code>Key</code> 而无法将 <code>node</code> 上的内存均衡化</li>
<li>大 <code>Key</code> 上的读请求使 <code>Redis</code> 实例占用服务器全部带宽，自身变慢的同时影响到该服务器上的其它服务</li>
<li>删除一个大 <code>Key</code> 造成主库较长时间的阻塞并引发同步中断或主从切换</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="hotkey"><code>HotKey</code><a href="#hotkey" class="hash-link" aria-label="Direct link to hotkey" title="Direct link to hotkey">​</a></h2>
<ul>
<li>某个 <code>Key</code> 接收到的访问次数显著高于其它 <code>Key</code> 时，可以将其称之为热 <code>Key</code></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="常见衡量指标-1">常见衡量指标<a href="#常见衡量指标-1" class="hash-link" aria-label="Direct link to 常见衡量指标" title="Direct link to 常见衡量指标">​</a></h3>
<ul>
<li><code>Redis</code> 实例的每秒总访问量为 <code>10000</code>，而其中一个 <code>Key</code> 的每秒访问量达到了 <code>7000</code>（访问次数显著高于其它 <code>Key</code>）</li>
<li>对一个拥有上千个成员且总大小为 <code>1MB</code> 的 <code>HASH Key</code> 每秒发送大量的 <code>HGETALL</code>（带宽占用显著高于其它 <code>Key</code>）</li>
<li>对一个拥有数万个成员的 <code>ZSET Key</code> 每秒发送大量的 <code>ZRANGE</code>（<code>CPU</code> 时间占用显著高于其它 <code>Key</code>）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="带来的问题-1">带来的问题<a href="#带来的问题-1" class="hash-link" aria-label="Direct link to 带来的问题" title="Direct link to 带来的问题">​</a></h3>
<ul>
<li>热<code> Key</code> 占用大量的 <code>Redis CPU</code> 时间使其性能变差并影响其它请 求</li>
<li><code>Redis Cluster</code> 中各 <code>node</code> 流量不均衡造成 <code>Redis Cluster</code> 的分布式优势无法被利用，一个分片负载很高而其它分片十分空闲从而产生读/写热点问题</li>
<li>在抢购、秒杀活动中，由于商品对应库存 <code>Key</code> 的请求量过大超出 <code>Redis</code> 处理能力造成超卖</li>
<li>热 <code>Key</code> 的请求压力数量超出 <code>Redis</code> 的承受能力造成缓存击穿，此时大量请求将直接指向后端存储将其打挂并影响到其它业务</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="pipeline">Pipeline<a href="#pipeline" class="hash-link" aria-label="Direct link to Pipeline" title="Direct link to Pipeline">​</a></h2>
<ul>
<li><code>Redis</code> 客户端执行一条命令分为四个过程：<code>发送命令 -&gt; 命令排队 -&gt; 命令执行 -&gt; 返回结果</code>，这整个过程称为 <code>Round trip time</code>(简称 <code>RTT</code>, 往返时间)，批量命令（<code>mget</code>、<code>mset</code>）有效节约了 <code>RTT</code>，但大部分命令（如 <code>hgetall</code>）不支持批量操作，需要消耗 <code>N</code> 次 <code>RTT</code>，这个时候需要 <code>Pipeline</code> 来解决这个问题。</li>
<li>使用 <code>Pipeline</code> 组装的命令个数不宜太多，不然数据量过大，增加客户端的等待时间，还可能造成网络阻塞，可以将大量命令的拆分多个小的 <code>Pipeline</code> 命令完成。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="原生批量命令mset-mget与-pipeline-对比">原生批量命令(<code>mset</code>, <code>mget</code>)与 <code>Pipeline</code> 对比<a href="#原生批量命令mset-mget与-pipeline-对比" class="hash-link" aria-label="Direct link to 原生批量命令mset-mget与-pipeline-对比" title="Direct link to 原生批量命令mset-mget与-pipeline-对比">​</a></h3>
<ul>
<li>原生批量命令是原子的，<code>Pipeline</code> 是非原子的</li>
<li>原生批量命令是一个命令对应多个 <code>key</code>，<code>Pipeline</code> 支持多个命令</li>
<li>原生批量命令是 <code>Redis</code> 服务端支持实现的，而 <code>Pipeline</code> 需要服务端和客户端的共同配合</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="hash-扩容"><code>hash</code> 扩容<a href="#hash-扩容" class="hash-link" aria-label="Direct link to hash-扩容" title="Direct link to hash-扩容">​</a></h2>
<ul>
<li>采用的是渐进式 <code>rehash</code> 的方式，两个 <code>dictht</code> 表，<code>rehashidx</code>。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="渐进式-rehash">渐进式 <code>rehash</code><a href="#渐进式-rehash" class="hash-link" aria-label="Direct link to 渐进式-rehash" title="Direct link to 渐进式-rehash">​</a></h3>
<ul>
<li>为 <code>ht[1]</code> 分配空间，让字典同时持有 <code>ht[0]</code> 和 <code>ht[1]</code> 两个哈希表</li>
<li>将 <code>rehashindex</code> 的值设置为 <code>0</code>，表示 <code>rehash</code> 工作正式开始</li>
<li>在 <code>rehash</code> 期间，在对 <code>hash</code> 执行增删改查操作时，同时还会将 <code>ht[0]</code> 哈希表在 <code>rehashindex</code> 索引上的所有键值对 <code>rehash</code> 到 <code>ht[1]</code>，当 <code>rehash</code> 工作完成以后，<code>rehashindex</code> 的值 <code>+1</code></li>
<li>随着字典操作的不断执行，最终会在某一时间段上 <code>ht[0]</code> 的所有键值对都会被 <code>rehash</code> 到 <code>ht[1]</code>，这时将 <code>rehashindex</code>的值设置为 <code>-1</code>，表示 <code>rehash</code> 操作结束</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="集群">集群<a href="#集群" class="hash-link" aria-label="Direct link to 集群" title="Direct link to 集群">​</a></h2>
<ul>
<li><code>Redis</code> 支持三种集群方案<!-- -->
<ul>
<li>主从复制模式</li>
<li><code>Sentinel</code>（哨兵）模式</li>
<li><code>Cluster</code> 模式</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主从复制模式">主从复制模式<a href="#主从复制模式" class="hash-link" aria-label="Direct link to 主从复制模式" title="Direct link to 主从复制模式">​</a></h3>
<ul>
<li>主从复制模式中包含一个主实例（<code>master</code>）与一个或多个从实例（<code>slave</code>），客户端可对主数据库进行读写操作，对从数据库进行读操作，主数据库写入的数据会实时自动同步给从数据库。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="工作机制">工作机制<a href="#工作机制" class="hash-link" aria-label="Direct link to 工作机制" title="Direct link to 工作机制">​</a></h4>
<ol>
<li><code>slave</code> 启动后，向 <code>master</code>发送 <code>SYNC</code> 命令，<code>master</code> 接收到 <code>SYNC</code> 命令后通过 <code>bgsave</code> 保存快照（即上文所介绍的 <code>RDB</code> 持久化），并使用缓冲区记录保存快照这段时间内执行的写命令</li>
<li><code>master</code> 将保存的快照文件发送给 <code>slave</code>，并继续记录执行的写命令</li>
<li><code>slave</code> 接收到快照文件后，加载快照文件，载入数据</li>
<li><code>master</code> 快照发送完后开始向 <code>slave</code> 发送缓冲区的写命令，<code>slave</code> 接收命令并执行，完成复制初始化</li>
<li>此后 <code>master</code> 每次执行一个写命令都会同步发送给 <code>slave</code>，保持 <code>master</code> 与 <code>slave</code> 之间数据的一致性</li>
</ol>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="优点">优点<a href="#优点" class="hash-link" aria-label="Direct link to 优点" title="Direct link to 优点">​</a></h4>
<ul>
<li><code>master</code> 能自动将数据同步到 <code>slave</code>，可以进行读写分离，分担 <code>master</code> 的读压力</li>
<li><code>master</code>、<code>slave</code> 之间的同步是以非阻塞的方式进行的，同步期间，客户端仍然可以提交查询或更新请求</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缺点">缺点<a href="#缺点" class="hash-link" aria-label="Direct link to 缺点" title="Direct link to 缺点">​</a></h4>
<ul>
<li>不具备自动容错与恢复功能，<code>master</code> 或 <code>slave</code> 的宕机都可能导致客户端请求失败，需要等待机器重启或手动切换客户端 <code>IP</code> 才能恢复</li>
<li><code>master</code> 宕机，如果宕机前数据没有同步完，则切换 <code>IP</code> 后会存在数据不一致的问题</li>
<li>难以支持在线扩容，<code>Redis</code> 的容量受限于单机配置</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sentinel哨兵模式"><code>Sentinel</code>（哨兵）模式<a href="#sentinel哨兵模式" class="hash-link" aria-label="Direct link to sentinel哨兵模式" title="Direct link to sentinel哨兵模式">​</a></h3>
<ul>
<li>哨兵模式基于主从复制模式，只是引入了哨兵来监控与自动处理故障。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="优点-1">优点<a href="#优点-1" class="hash-link" aria-label="Direct link to 优点" title="Direct link to 优点">​</a></h4>
<ul>
<li>哨兵模式基于主从复制模式，所以主从复制模式有的优点，哨兵模式也有</li>
<li>哨兵模式下，<code>master</code> 挂掉可以自动进行切换，系统可用性更高</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缺点-1">缺点<a href="#缺点-1" class="hash-link" aria-label="Direct link to 缺点" title="Direct link to 缺点">​</a></h4>
<ul>
<li>同样也继承了主从模式难以在线扩容的缺点，<code>Redis</code> 的容量受限于单机配置</li>
<li>需要额外的资源来启动 <code>sentinel</code> 进程，实现相对复杂一点，同 时 <code>slave</code> 节点作为备份节点不提供服务</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cluster-模式"><code>Cluster</code> 模式<a href="#cluster-模式" class="hash-link" aria-label="Direct link to cluster-模式" title="Direct link to cluster-模式">​</a></h3>
<ul>
<li><code>Cluster</code> 模式实现了 <code>Redis</code> 的分布式存储，即每台节点存储不同的内容，来解决在线扩容的问题。<code>Cluster</code> 采用无中心结构，它的特点如下：<!-- -->
<ul>
<li>所有的 <code>redis</code> 节点彼此互联（<code>PING-PONG</code> 机制），内部使用二进制协议优化传输速度和带宽</li>
<li>节点的 <code>fail</code> 是通过集群中超过半数的节点检测失效时才生效</li>
<li>客户端与 <code>redis</code> 节点直连，不需要中间代理层，客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可</li>
</ul>
</li>
<li><code>Cluster</code> 模式集群节点最小配置 <code>6</code> 个节点(<code>3</code> 主 <code>3</code> 从，因为需要半数以上)，其中主节点提供读写操作，从节点作为备用节点，不提供请求，只作为故障转移使用。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="工作机制-1">工作机制<a href="#工作机制-1" class="hash-link" aria-label="Direct link to 工作机制" title="Direct link to 工作机制">​</a></h4>
<ol>
<li>在 <code>Redis</code> 的每个节点上，都有一个插槽（<code>slot</code>），取值范围为 <code>0-16383</code></li>
<li>当存取 <code>key</code> 的时候，<code>Redis</code> 会根据 <code>CRC16</code> 的算法得出一个结果，然后把结果对 <code>16384</code>求余数，这样每个 <code>key</code> 都会对应一个编号在 <code>0-16383</code> 之间的哈希槽，通过这个值，去找到对应的插槽所对应的节点，然后直接自动跳转到这个对应的节点上进行存取操作</li>
<li>为了保证高  可用，<code>Cluster</code> 模式也引入主从复制模式，一个主节点对应一个或者多个从节点，当主节点宕机的时候，就会启用从节点</li>
<li>当其它主节点 <code>ping</code> 一个主节点 <code>A</code> 时，如果半数以上的主节点与 <code>A</code> 通信超时，那么认为主节点 <code>A</code> 宕机了。如果主节点 <code>A</code> 和它的从节点都宕机了，那么该集群就无法再提供服务了</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redis-事件模型"><code>Redis</code> 事件模型<a href="#redis-事件模型" class="hash-link" aria-label="Direct link to redis-事件模型" title="Direct link to redis-事件模型">​</a></h2>
<ul>
<li><code>Redis</code> 服务器是一个事件驱动程序，主要处理文件事件（<code>file event</code>）和时间事件（<code>time event</code>）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文件事件">文件事件<a href="#文件事件" class="hash-link" aria-label="Direct link to 文件事件" title="Direct link to 文件事件">​</a></h3>
<ul>
<li><code>Redis</code> 服务器通过套接字与客户端进行连接，而文件事件就是对套接字操作的抽象，可以将其理解为 <code>IO事件</code></li>
<li><code>Redis</code> 将 <code>IO事件</code> 放入一个就绪队列中（<code>redisServer.aeEventLoop.fired</code> 数组），然后在 <code>aeProcessEvents</code> 会依次分派给文件事件处理器处理</li>
<li><code>Redis</code> 中文件事件包括：客户端的连接、命令请求、数据回复、连接断开等，当上述事件发生时，会使得相应的描述符可读可写，再调用相应类型的文件事件处理器。</li>
<li><code>Redis</code> 文件事件处理器有：连接应答处理器（<code>networking.c/acceptTcpHandler</code>）、命令请求处理器（<code>networking.c/readQueryFromClinet</code>）、命令回复处理器（<code>networking.c/sendReplyToClient</code>）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="时间事件">时间事件<a href="#时间事件" class="hash-link" aria-label="Direct link to 时间事件" title="Direct link to 时间事件">​</a></h3>
<ul>
<li>时间事件包含<code>定时事件</code>和<code>周期性</code>事件，<code>Redis</code> 将其放入一个单向无序链表中，每当时间事件执行器运行时，就遍历链表，查找已经到达的时间事件，调用相应的处理器。<!-- -->
<ul>
<li>定时事件：让一段程序在指定的时间之后执行一次，比如让程序X在当前时间 <code>30ms</code> 之后执行一次</li>
<li>周期事件：让一段程序每隔指定时间就执行一次，比如让程序 <code>Y</code> 每隔 <code>30ms</code> 就执行一次</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文件事件的处理">文件事件的处理<a href="#文件事件的处理" class="hash-link" aria-label="Direct link to 文件事件的处理" title="Direct link to 文件事件的处理">​</a></h3>
<ul>
<li>事件分派器（<code>Initiation Dispatcher</code>）</li>
<li>IO多路复用（<code>Synchronous Event Demultiplexer</code>）</li>
<li>事件循环调度</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redis-key-删除策略"><code>Redis key</code> 删除策略<a href="#redis-key-删除策略" class="hash-link" aria-label="Direct link to redis-key-删除策略" title="Direct link to redis-key-删除策略">​</a></h2>
<ul>
<li><code>Redis</code> 是一种内存型数据库，数据都是存放在内存中的，内存中的数据可以通过 <code>TTL</code> 指令获取其状态<!-- -->
<ul>
<li>XX：具有时效性的数据</li>
<li>-1：永久有效的数据</li>
<li>-2：已经过期的数据 / 被删除的数据 / 未定义的数据</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="删除-key-的方式">删除 key 的方式<a href="#删除-key-的方式" class="hash-link" aria-label="Direct link to 删除 key 的方式" title="Direct link to 删除 key 的方式">​</a></h3>
<ul>
<li>被动删除：当读/写一个已经过期的 <code>key</code> 时，会触发惰性删除策略，直接删除掉这个过期 <code>key</code></li>
<li>主动删除：由于惰性删除策略无法保证冷数据被及时删掉，所以 <code>Redis</code> 会定期主动淘汰一批已过期的 <code>key</code></li>
<li>当前已用内存超过 <code>maxmemory</code> 限定时，触发主动清理策略</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="定时删除">定时删除<a href="#定时删除" class="hash-link" aria-label="Direct link to 定时删除" title="Direct link to 定时删除">​</a></h4>
<ul>
<li>创建一个定时器，当 <code>key</code> 设置有过期时间，且过期时间到达时，由定时器任务立即执行对键的删除操作</li>
<li>优点：节约内存，到时就删除，快速释放掉不必要的内存占用</li>
<li>缺点：<code>CPU</code> 压力很大，无论 <code>CPU</code> 此时负载量多高，均占用 <code>CPU</code>，会影响 <code>redis</code> 服务器响应时间和指令吞吐量</li>
<li>总结：用处理器性能换取存储空间（拿时间换空间）</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="惰性删除">惰性删除<a href="#惰性删除" class="hash-link" aria-label="Direct link to 惰性删除" title="Direct link to 惰性删除">​</a></h4>
<ul>
<li>数据到达过期时间，不做处理，等下次访问该数据时，如果未过期，返回数据，反之则删除并返回不存在</li>
<li>优点：节约 <code>CPU</code> 性能，发现必须删除的时候才删除</li>
<li>缺点：内存压力很大，出现长期占用内存的数据</li>
<li>总结：用存储空间换取处理器性能（拿空间换时间）</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="定期删除">定期删除<a href="#定期删除" class="hash-link" aria-label="Direct link to 定期删除" title="Direct link to 定期删除">​</a></h4>
<ul>
<li>周期性轮询 <code>redis</code> 库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度</li>
<li>特点1：<code>CPU</code> 性能占用设置有峰值，检测频度可自定义设置</li>
<li>特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理</li>
<li>总结：周期性抽查存储空间（随机抽查，重点抽查）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="逐出算法">逐出算法<a href="#逐出算法" class="hash-link" aria-label="Direct link to 逐出算法" title="Direct link to 逐出算法">​</a></h3>
<ul>
<li><code>Redis</code> 清理数据的策略称为逐出算法</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="内存淘汰机制">内存淘汰机制<a href="#内存淘汰机制" class="hash-link" aria-label="Direct link to 内存淘汰机制" title="Direct link to 内存淘汰机制">​</a></h3>
<ul>
<li>如果 <code>Redis</code> 服务器打开了 <code>maxmemory</code> 选项，并且服务器占用的内存数超过了 <code>maxmemory</code> 选项所设置的上限值时，会进行内存淘汰，常见的淘汰策略如下：<!-- -->
<ul>
<li><code>volatile-lru</code>：从已设置过期时间的数据集中挑选最近最少使用的数据淘汰</li>
<li><code>volatile-ttl</code>：从已设置过期时间的数据集中挑选将要过期的数据淘汰</li>
<li><code>volatile-random</code>：从已设置过期时间的数据集中任意选择数据淘汰</li>
<li><code>volatile-lfu</code>：从已设置过期时间的数据集挑选使用频率最低的数据淘汰</li>
<li><code>allkeys-lru</code>：从数据集（server.db[i].dict）中挑选最近最少使用的数据淘汰</li>
<li><code>allkeys-lfu</code>：从数据集（server.db[i].dict）中挑选使用频率最低的数据淘汰</li>
<li><code>allkeys-random</code>：从数据集（server.db[i].dict）中任意选择数据淘汰</li>
<li><code>no-enviction</code>：禁止驱逐数据，这也是默认策略。当内存不足以容纳新入数据时，新写入操作就会报错，请求可以继续进行。采用 <code>no-enviction</code> 策略可以保证数据不被丢失。</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="aof-vs-rdb"><code>AOF</code> vs. <code>RDB</code><a href="#aof-vs-rdb" class="hash-link" aria-label="Direct link to aof-vs-rdb" title="Direct link to aof-vs-rdb">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="rdb"><code>RDB</code><a href="#rdb" class="hash-link" aria-label="Direct link to rdb" title="Direct link to rdb">​</a></h3>
<ul>
<li><code>RDB</code>（<code>Redis DataBase</code>）是 <code>Redis</code> 默认的持久化方案。在指定的时间间隔内，执行指定次数的写操作，则会将内存中的数据写入到磁盘中，即在指定目录下生成一个 <code>dump.rdb</code> 文件。<code>Redis</code> 重启后会通过加载 <code>dump.rdb</code> 文件恢复数据。<code>save（阻塞） / bgsave（异步） / flushall / flushall</code> 命令也会触发生成快照。</li>
<li>优点<!-- -->
<ul>
<li>适合大规模的数据恢复</li>
<li>如果业务对数据完整性和一致性要求不高，<code>RDB</code> 是很好的选择</li>
</ul>
</li>
<li>缺点<!-- -->
<ul>
<li>数据的完整性和一致性不高，因为可能在备份时宕机</li>
<li>备份时占用内存，因为在备份时会独立创建一个子进程，将数据写入到一个临时文件，最后再将临时文件替换之前的备份文件</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="aof"><code>AOF</code><a href="#aof" class="hash-link" aria-label="Direct link to aof" title="Direct link to aof">​</a></h3>
<ul>
<li>默认不开启。是为了弥补RDB的不足（数据的不一致性），采用日志的形式来记录每个写操作，并追加到文件中。<code>Redis</code> 重启后会根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。根据配置文件触发，可以是每次执行触发，可以是每秒触发，可以是不同步。</li>
<li>重写机制<!-- -->
<ul>
<li>当 <code>AOF</code> 文件的大小超过所设定的阈值时，<code>Redis</code> 就会对 <code>AOF</code> 文件的内容压缩。</li>
<li><code>Redis</code> 会 <code>fork</code> 出一个新进程，读取内存中的数据，并重新写到一个临时文件中，最后替换旧的 <code>AOF</code> 文件。</li>
<li>当 <code>AOF</code> 文件大小是上次 <code>rewrite</code> 后大小的一倍且文件大于 <code>64M</code> 时触发。这里的 <code>一倍</code> 和 <code>64M</code> 可以通过配置文件修改。</li>
</ul>
</li>
<li>优点<!-- -->
<ul>
<li>数据的完整性和一致性更高</li>
</ul>
</li>
<li>缺点<!-- -->
<ul>
<li>因为 <code>AOF</code> 记录的内容多，文件会越来越大，数据恢复也会越来越慢</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="缓冲区">缓冲区<a href="#缓冲区" class="hash-link" aria-label="Direct link to 缓冲区" title="Direct link to 缓冲区">​</a></h2>
<ul>
<li>缓冲区的功能是用一块内存来暂存命令数据，避免出现因为数据和命令的处理速度慢于发送速度而导致的数据丢失和性能问题。但缓冲区的内存空间有限，如果发生溢出，就会丢失数据。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端输入缓冲区请求">客户端输入缓冲区（请求）<a href="#客户端输入缓冲区请求" class="hash-link" aria-label="Direct link to 客户端输入缓冲区（请求）" title="Direct link to 客户端输入缓冲区（请求）">​</a></h3>
<ul>
<li>会先把客户端发送过来的命令暂存起来，<code>Redis</code> 主线程再从输入缓冲区中读取命令，进行处理</li>
<li>溢出场景（会导致关闭客户端连接）<!-- -->
<ul>
<li>请求写入大量数据（<code>BigKey</code>）</li>
<li>生产速度大于消费速度，慢慢被填满</li>
</ul>
</li>
<li>优化（缓冲区大小无法调整，服务端默认为每个客户端输入缓冲区分配的大小是 <code>1GB</code>）<!-- -->
<ul>
<li>拆分请求数据，避免写入 <code>BigKey</code></li>
<li>定位处理服务端阻塞问题</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端输出缓冲区响应">客户端输出缓冲区（响应）<a href="#客户端输出缓冲区响应" class="hash-link" aria-label="Direct link to 客户端输出缓冲区（响应）" title="Direct link to 客户端输出缓冲区（响应）">​</a></h3>
<ul>
<li>会先把客户端发送过来的命令的响应暂存起来</li>
<li>溢出场景（会导致关闭客户端连接）<!-- -->
<ul>
<li>服务器端返回了大量数据</li>
<li>返回数据的速度太快，比如执行 <code>MONITOR</code> 命令，它会持续输出监测到的各个命令操作</li>
<li>缓冲区大小设置得不合理</li>
</ul>
</li>
<li>优化<!-- -->
<ul>
<li>避免 <code>BigKey</code> 操作返回大量数据，避免在线上持续执行 <code>MONITOR</code> 命令</li>
<li>使用 <code>client-output-buffer-limit</code> 设置合理的缓冲区大小上限，或是缓冲区连续写入时间和写入量上限</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="复制缓冲区">复制缓冲区<a href="#复制缓冲区" class="hash-link" aria-label="Direct link to 复制缓冲区" title="Direct link to 复制缓冲区">​</a></h3>
<ul>
<li>暂存全量同步数据</li>
<li>溢出场景（会导致关闭同步连接）<!-- -->
<ul>
<li>从节点接收和加载 <code>RDB</code> 较慢，同时主节点接收到了大量的写命令，写命令在复制缓冲区中就会越积越多</li>
</ul>
</li>
<li>优化<!-- -->
<ul>
<li>控制主节点保存的数据量大小，通常控制在 <code>2 ~ 4GB</code></li>
<li>通过 <code>client-output-buffer-limit</code> 配置项来设置合理的复制缓冲  区大小</li>
<li>复制缓冲区是在主节点上的，如果集群中的从节点非常多，主节点的内存开销就会非常大，必须得控制和主节点连接的从节点个数</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="复制积压缓冲区">复制积压缓冲区<a href="#复制积压缓冲区" class="hash-link" aria-label="Direct link to 复制积压缓冲区" title="Direct link to 复制积压缓冲区">​</a></h3>
<ul>
<li>暂存增量同步数据</li>
<li>溢出场景（会导致增量同步失败转为全量同步）<!-- -->
<ul>
<li>是一个大小有限的环形缓冲区，当写入速度比读取速度要快，会导入新写入的命令数据覆盖缓冲区中的旧命令数据</li>
</ul>
</li>
<li>优化<!-- -->
<ul>
<li>通过 <code>repl_backlog_size</code> 配置项来调整复制积压缓冲区的大小</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="redis-事务">Redis 事务<a href="#redis-事务" class="hash-link" aria-label="Direct link to Redis 事务" title="Direct link to Redis 事务">​</a></h2>
<p><a href="https://www.cnblogs.com/yidengjiagou/p/17373712.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/yidengjiagou/p/17373712.html</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/interview/database/mysql"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">MySQL</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/interview/framework/mybatis"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MyBatis</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#分布式锁" class="table-of-contents__link toc-highlight">分布式锁</a><ul><li><a href="#保证加锁时设置过期时间的原子性" class="table-of-contents__link toc-highlight">保证加锁时设置过期时间的原子性</a></li><li><a href="#防止超时后释放锁时误删其他线程的锁" class="table-of-contents__link toc-highlight">防止超时后释放锁时误删其他线程的锁</a></li><li><a href="#保证删除锁时的原子性" class="table-of-contents__link toc-highlight">保证删除锁时的原子性</a></li></ul></li><li><a href="#跳表" class="table-of-contents__link toc-highlight">跳表</a><ul><li><a href="#skiplist-与平衡树哈希表的比较" class="table-of-contents__link toc-highlight"><code>skiplist</code> 与平衡树、哈希表的比较</a></li></ul></li><li><a href="#bigkey" class="table-of-contents__link toc-highlight"><code>BigKey</code></a><ul><li><a href="#常见衡量指标" class="table-of-contents__link toc-highlight">常见衡量指标</a></li><li><a href="#带来的问题" class="table-of-contents__link toc-highlight">带来的问题</a></li></ul></li><li><a href="#hotkey" class="table-of-contents__link toc-highlight"><code>HotKey</code></a><ul><li><a href="#常见衡量指标-1" class="table-of-contents__link toc-highlight">常见衡量指标</a></li><li><a href="#带来的问题-1" class="table-of-contents__link toc-highlight">带来的问题</a></li></ul></li><li><a href="#pipeline" class="table-of-contents__link toc-highlight">Pipeline</a><ul><li><a href="#原生批量命令mset-mget与-pipeline-对比" class="table-of-contents__link toc-highlight">原生批量命令(<code>mset</code>, <code>mget</code>)与 <code>Pipeline</code> 对比</a></li></ul></li><li><a href="#hash-扩容" class="table-of-contents__link toc-highlight"><code>hash</code> 扩容</a><ul><li><a href="#渐进式-rehash" class="table-of-contents__link toc-highlight">渐进式 <code>rehash</code></a></li></ul></li><li><a href="#集群" class="table-of-contents__link toc-highlight">集群</a><ul><li><a href="#主从复制模式" class="table-of-contents__link toc-highlight">主从复制模式</a></li><li><a href="#sentinel哨兵模式" class="table-of-contents__link toc-highlight"><code>Sentinel</code>（哨兵）模式</a></li><li><a href="#cluster-模式" class="table-of-contents__link toc-highlight"><code>Cluster</code> 模式</a></li></ul></li><li><a href="#redis-事件模型" class="table-of-contents__link toc-highlight"><code>Redis</code> 事件模型</a><ul><li><a href="#文件事件" class="table-of-contents__link toc-highlight">文件事件</a></li><li><a href="#时间事件" class="table-of-contents__link toc-highlight">时间事件</a></li><li><a href="#文件事件的处理" class="table-of-contents__link toc-highlight">文件事件的处理</a></li></ul></li><li><a href="#redis-key-删除策略" class="table-of-contents__link toc-highlight"><code>Redis key</code> 删除策略</a><ul><li><a href="#删除-key-的方式" class="table-of-contents__link toc-highlight">删除 key 的方式</a></li><li><a href="#逐出算法" class="table-of-contents__link toc-highlight">逐出算法</a></li><li><a href="#内存淘汰机制" class="table-of-contents__link toc-highlight">内存淘汰机制</a></li></ul></li><li><a href="#aof-vs-rdb" class="table-of-contents__link toc-highlight"><code>AOF</code> vs. <code>RDB</code></a><ul><li><a href="#rdb" class="table-of-contents__link toc-highlight"><code>RDB</code></a></li><li><a href="#aof" class="table-of-contents__link toc-highlight"><code>AOF</code></a></li></ul></li><li><a href="#缓冲区" class="table-of-contents__link toc-highlight">缓冲区</a><ul><li><a href="#客户端输入缓冲区请求" class="table-of-contents__link toc-highlight">客户端输入缓冲区（请求）</a></li><li><a href="#客户端输出缓冲区响应" class="table-of-contents__link toc-highlight">客户端输出缓冲区（响应）</a></li><li><a href="#复制缓冲区" class="table-of-contents__link toc-highlight">复制缓冲区</a></li><li><a href="#复制积压缓冲区" class="table-of-contents__link toc-highlight">复制积压缓冲区</a></li></ul></li><li><a href="#redis-事务" class="table-of-contents__link toc-highlight">Redis 事务</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 TTS, Inc. Built with <a href="https://docusaurus.io/" target="_blank">Docusaurus</a>.</div></div></div></footer></div>
</body>
</html>